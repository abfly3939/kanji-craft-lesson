async function parseMcstructureFile(file) {
  const buf = await file.arrayBuffer();

  // Little Endian を明示し、Buffer で渡す
  const { parsed } = await nbt.parse(Buffer.from(buf), 'little');
  const root = nbt.simplify(parsed);
  console.log('NBT root (simplified):', root); // 構造確認用

  // よくある配置：root.structure.* もしくは root.* 直下
  const struct = root.structure ?? root;

  // サイズ [x, y, z] または {x,y,z} の両対応
  let size = struct.size;
  if (!size) throw new Error('size 情報が見つかりません');
  if (!Array.isArray(size)) size = [Number(size.x), Number(size.y), Number(size.z)];
  const [sx, sy, sz] = size.map(Number);

  // パレット抽出（Bedrock は block_palette が一般的）
  let paletteEntries = [];
  if (Array.isArray(struct.palette) && struct.palette[0]) {
    const p0 = struct.palette[0];
    const blockPalette = p0.block_palette ?? p0.BlockPalette ?? p0['block_palette'];
    if (Array.isArray(blockPalette)) {
      paletteEntries = blockPalette.map(e => e?.name ?? e?.Name ?? 'minecraft:unknown');
    }
  }
  if (paletteEntries.length === 0) {
    console.warn('palette が取得できませんでした。フォールバックとして index 0 を空気扱いします。');
  }

  // block_indices：型の差異を包括的に復元
  const indicesSrc = struct.block_indices ?? struct.BlockIndices ?? struct['block_indices'];
  if (!indicesSrc) throw new Error('block_indices が見つかりません');

  const indices = [];
  const pushAny = (v) => {
    if (!v) return;
    if (ArrayBuffer.isView(v)) indices.push(...v);
    else if (Array.isArray(v)) indices.push(...v.map(Number));
    else if (v.data && ArrayBuffer.isView(v.data)) indices.push(...v.data);
    else if (v.value && Array.isArray(v.value)) indices.push(...v.value.map(Number));
    else console.warn('未知の block_indices 片の形です:', v);
  };
  Array.isArray(indicesSrc) ? indicesSrc.forEach(pushAny) : pushAny(indicesSrc);

  const total = sx * sy * sz;
  if (indices.length < total) {
    console.warn(`block_indices 長が不足 (${indices.length} < ${total})。並びや圧縮形式が異なる可能性があります。`);
  }

  const isAirName = (name) => name === 'minecraft:air' || name === 'minecraft:cave_air' || name === 'minecraft:void_air';
  const isAirIndex = (idx) => {
    if (paletteEntries.length === 0) return idx === 0; // パレット不明時フォールバック
    const name = paletteEntries[idx] ?? 'minecraft:unknown';
    return isAirName(name);
  };

  // 走査順：x 最内、y 次、z 最外（x + y*sx + z*sx*sy）
  const positions = [];
  for (let z = 0; z < sz; z++) {
    for (let y = 0; y < sy; y++) {
      for (let x = 0; x < sx; x++) {
        const idx = x + y * sx + z * sx * sy;
        const pIndex = indices[idx] ?? 0;
        if (!isAirIndex(pIndex)) positions.push([x, y, z]);
      }
    }
  }
  return { positions, size: 1 };
}
